# ============================================
# ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìë™í™” ì‹œìŠ¤í…œ - CI/CD Pipeline
# GitHub Actions ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ============================================

name: Deploy to Hetzner Server

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

env:
  DOCKER_IMAGE: naver-blog-bot
  DEPLOY_PATH: ~/service_b/naver-blog-bot

jobs:
  # ============================================
  # Job 1: í…ŒìŠ¤íŠ¸ ë° ë¦°íŠ¸
  # ============================================
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest pytest-asyncio black mypy
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          # ë¬¸ë²• ì˜¤ë¥˜ ë° ì¤‘ìš” ë¬¸ì œë§Œ ì²´í¬
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # ë³µì¡ë„ ì²´í¬ (ê²½ê³ ë§Œ)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with Black
        run: |
          black --check --diff . || true

      - name: Type check with mypy
        run: |
          mypy --ignore-missing-imports --no-error-summary . || true

  # ============================================
  # Job 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ
  # ============================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker buildx build \
            --file ./Dockerfile \
            --tag "$DOCKER_IMAGE:$IMAGE_TAG" \
            --load \
            .

      - name: Save Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker save "$DOCKER_IMAGE:$IMAGE_TAG" | gzip > docker-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar.gz
          retention-days: 1

  # ============================================
  # Job 3: ì„œë²„ ë°°í¬
  # ============================================
  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Setup SSH key
        env:
          SSH_KEY: ${{ secrets.HETZNER_SSH_KEY }}
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create deployment directory on server
        env:
          SSH_USER: ${{ secrets.HETZNER_USER }}
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            mkdir -p $DEPLOY_PATH
            mkdir -p $DEPLOY_PATH/logs
            mkdir -p $DEPLOY_PATH/generated_images
            mkdir -p $DEPLOY_PATH/data
            mkdir -p $DEPLOY_PATH/secrets
          "

      - name: Transfer Docker image to server
        env:
          SSH_USER: ${{ secrets.HETZNER_USER }}
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
        run: |
          scp -o StrictHostKeyChecking=no docker-image.tar.gz \
            "$SSH_USER@$SSH_HOST:$DEPLOY_PATH/"

      - name: Transfer deployment files
        env:
          SSH_USER: ${{ secrets.HETZNER_USER }}
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
        run: |
          scp -o StrictHostKeyChecking=no docker-compose.yml \
            "$SSH_USER@$SSH_HOST:$DEPLOY_PATH/"
          scp -o StrictHostKeyChecking=no .env.example \
            "$SSH_USER@$SSH_HOST:$DEPLOY_PATH/"

      - name: Deploy on server
        env:
          SSH_USER: ${{ secrets.HETZNER_USER }}
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            cd $DEPLOY_PATH

            # Docker ì´ë¯¸ì§€ ë¡œë“œ
            echo 'ğŸ”„ Loading Docker image...'
            gunzip -c docker-image.tar.gz | docker load

            # ì´ë¯¸ì§€ íƒœê·¸ ë³€ê²½
            docker tag $DOCKER_IMAGE:$IMAGE_TAG $DOCKER_IMAGE:latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo 'ğŸ›‘ Stopping existing container...'
            docker-compose down --remove-orphans || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo 'ğŸš€ Starting new container...'
            docker-compose up -d

            # ì •ë¦¬
            echo 'ğŸ§¹ Cleaning up...'
            rm -f docker-image.tar.gz
            docker image prune -f

            # ìƒíƒœ í™•ì¸
            echo 'âœ… Deployment complete!'
            docker ps | grep $DOCKER_IMAGE
          "

      - name: Health check
        env:
          SSH_USER: ${{ secrets.HETZNER_USER }}
          SSH_HOST: ${{ secrets.HETZNER_HOST }}
        run: |
          echo "Waiting for container to start..."
          sleep 30
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            docker ps | grep $DOCKER_IMAGE && echo 'âœ… Container is running!' || echo 'âŒ Container failed to start'
            docker logs $DOCKER_IMAGE --tail 20 || true
          "

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Deployment successful!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs for more details."

  # ============================================
  # Job 4: Telegram ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  # ============================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEPLOY_STATUS: ${{ needs.deploy.result }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          REF_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "Telegram token not configured, skipping notification"
            exit 0
          fi

          if [ "$DEPLOY_STATUS" == "success" ]; then
            EMOJI="âœ…"
            MESSAGE="ë°°í¬ ì„±ê³µ!"
          else
            EMOJI="âŒ"
            MESSAGE="ë°°í¬ ì‹¤íŒ¨!"
          fi

          # Telegram API í˜¸ì¶œ (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©ìœ¼ë¡œ injection ë°©ì§€)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT}" \
            -d "parse_mode=HTML" \
            -d "text=${EMOJI} <b>ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë´‡ ${MESSAGE}</b>

          ğŸ“¦ ì»¤ë°‹: <code>${COMMIT_SHA}</code>
          ğŸ‘¤ ì‘ì„±ì: ${ACTOR}
          ğŸŒ¿ ë¸Œëœì¹˜: ${REF_NAME}
          ğŸ”— <a href='https://github.com/${REPO}/actions/runs/${RUN_ID}'>Actions ë¡œê·¸</a>" || true
